<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Context-based Meaning Selection Task</title>
  <style>
    body {
      font-family: "Noto Sans KR", "Segoe UI", sans-serif;
      background-color: #f1f3f5;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }
    #experiment {
      background-color: #ffffff;
      width: 840px;
      padding: 50px 40px;
      border-radius: 16px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
      text-align: center;
    }
    h2 {
      font-size: 28px;
      margin-bottom: 20px;
      color: #333;
    }
    p {
      font-size: 18px;
      line-height: 1.7;
      color: #444;
    }
    #sentence {
      font-size: 26px;
      font-weight: 400;
      margin: 40px 0 30px;
      color: #222;
    }
    #options {
      font-size: 44px;
      font-weight: 400;
      margin: 30px 0;
      display: none;
      color: #1a1a1a;
    }
    #feedback {
      font-size: 22px;
      font-weight: bold;
      height: 32px;
      margin-top: 20px;
    }
    #progress {
      font-size: 16px;
      color: #888;
      margin-bottom: 12px;
    }
    input[type="text"] {
      font-size: 18px;
      padding: 10px 16px;
      width: 300px;
      border-radius: 8px;
      border: 1px solid #ccc;
      margin-top: 10px;
    }
    button {
      font-size: 18px;
      padding: 10px 20px;
      margin-top: 16px;
      border: none;
      border-radius: 8px;
      background-color: #4a90e2;
      color: white;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }
    button:hover {
      background-color: #3b78c2;
    }
    @media (max-width: 600px) {
      #experiment {
        width: 90%;
        padding: 30px 20px;
      }
      #sentence {
        font-size: 22px;
      }
      #options {
        font-size: 32px;
      }
      input[type="text"] {
        width: 100%;
      }
    }
  </style>
</head>
<body>
<div id="experiment">
  <div id="progress" style="display:none;"></div>
  <div id="inputName">
    <h2>ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”</h2>
    <input type="text" id="participantName">
    <button id="startBtn">Start</button>
    <p>
      <strong><u>â€» ë°˜ë“œì‹œ ì‹¤ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.</strong></u>
    </p>
  </div>
  <div id="instructions" style="display:none;">
    <p>
      ë³¸ ì‹¤í—˜ì€ <strong>ë¬¸ë§¥ ê¸°ë°˜ ì˜ë¯¸ ì„ íƒ ê³¼ì œ(Context-based Meaning Selection Task)</strong>ì…ë‹ˆë‹¤.<br><br> 

      ğŸ“ ì§„í–‰ ë°©ë²•<br><br>  
      1. ì‹¤í—˜ì€ ì˜ì–´ë¡œ ì§„í–‰ë©ë‹ˆë‹¤.<br> 
      2. ë¬¸ì¥ ì† <strong><u>ë°‘ì¤„ ì¹œ ë‹¨ì–´</strong></u>ê°€ ë¬¸ë§¥ìƒ ì–´ë–¤ ì˜ë¯¸ë¡œ ì“°ì˜€ëŠ”ì§€ íŒë‹¨í•´ ì£¼ì„¸ìš”.<br>
      3. ë‹¤ ì½ì€ í›„, <strong><u>ìŠ¤í˜ì´ìŠ¤ë°” ë˜ëŠ” ì—”í„° í‚¤</strong></u>ë¥¼ ëˆ„ë¥´ë©´ <strong><u>ë‘ ê°œì˜ ë‹¨ì–´ ì„ íƒì§€</strong></u>ê°€ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.<br>
      4. ë¬¸ë§¥ì— ë” ì ì ˆí•œ ë‹¨ì–´ë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.<br><br> 

      âŒ¨ íŒë‹¨ ë°©ë²•<br><br> 
      1. ì™¼ìª½ ë‹¨ì–´ê°€ ë” ì ì ˆí•˜ë©´: <strong>â†</strong> í‚¤ë¥¼ ëˆ„ë¥´ì„¸ìš”.<br>
      2. ì˜¤ë¥¸ìª½ ë‹¨ì–´ê°€ ë” ì ì ˆí•˜ë©´: <strong>â†’</strong> í‚¤ë¥¼ ëˆ„ë¥´ì„¸ìš”.<br><br><br>

      ê°€ëŠ¥í•œ í•œ ë¹ ë¥´ê³  ì •í™•í•˜ê²Œ íŒë‹¨í•´ ì£¼ì„¸ìš”.<br><br>

      ğŸ§ª ì§€ê¸ˆë¶€í„° ì—°ìŠµ ì‹œí–‰ì„ ì‹œì‘í•˜ê² ìŠµë‹ˆë‹¤. <strong>ìŠ¤í˜ì´ìŠ¤ë°” ë˜ëŠ” ì—”í„°</strong>ë¥¼ ëˆ„ë¥´ì„¸ìš”. 
    </p>
  </div>
  <div id="transition" style="display:none;">
    <p>
      ì—°ìŠµ ì‹œí–‰ì´ ëë‚¬ìŠµë‹ˆë‹¤.<br>
      ì´ì œë¶€í„° ë³¸ ì‹œí–‰ì´ ì‹œì‘ë©ë‹ˆë‹¤. í”¼ë“œë°±ì€ ì œê³µë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.<br><br>
      <strong>ìŠ¤í˜ì´ìŠ¤ë°” ë˜ëŠ” ì—”í„°</strong>ë¥¼ ëˆŒëŸ¬ ë³¸ ì‹œí–‰ì„ ì‹œì‘í•˜ì„¸ìš”.
    </p>
  </div>
  <div id="sentence" style="display:none;"></div>
  <div id="options" style="display:none;"></div>
  <div id="feedback"></div>
  <button id="downloadBtn" style="display:none;" onclick="downloadCSV()">ê²°ê³¼ ë‹¤ìš´ë¡œë“œ</button>
</div>

<script>
const practiceTrials = [
  { word: "dog", biasMeaning: "ë™ë¬¼", sentence: "The <u>dog</u> barked loudly in the yard.", left: "cat", right: "car", correct: "cat" },
  { word: "sun", biasMeaning: "í•´", sentence: "The <u>sun</u> rose above the mountains.", left: "moon", right: "cloud", correct: "moon" },
  { word: "apple", biasMeaning: "ê³¼ì¼", sentence: "She ate a juicy red <u>apple</u>.", left: "banana", right: "stone", correct: "banana" }
];

const mainTrials = [
  { word: "bat", biasMeaning: "ë°•ì¥", sentence: "We saw a <u>bat</u> flying in the dark cave at night.", left: "vampire", right: "glove", correct: "vampire" },
  { word: "bat", biasMeaning: "ë°©ë§ì´", sentence: "He swung the <u>bat</u> to hit the ball.", left: "vampire", right: "glove", correct: "glove" },
  { word: "bugs", biasMeaning: "ë²Œë ˆ", sentence: "The garden was full of little <u>bugs</u> crawling around.", left: "listen", right: "insect", correct: "insect" },
  { word: "bugs", biasMeaning: "ë„ì²­ì¥ì¹˜", sentence: "A North Korean spy was searching for concealed <u>bugs</u> in the room.", left: "listen", right: "insect", correct: "listen" },
  { word: "palm", biasMeaning: "ì†ë°”ë‹¥", sentence: "She felt something strange on her <u>palm</u>.", left: "thumb", right: "coconut", correct: "thumb" },
  { word: "palm", biasMeaning: "ì•¼ììˆ˜", sentence: "We rested in the shade of a tall <u>palm</u> tree in the warm wind.", left: "thumb", right: "coconut", correct: "coconut" },
  { word: "spring", biasMeaning: "ë´„", sentence: "The flowers started blooming in the <u>spring</u>.", left: "butterfly", right: "silver", correct: "butterfly" },
  { word: "spring", biasMeaning: "ìš©ìˆ˜ì² ", sentence: "The <u>spring</u> expanded when the weight was removed.", left: "butterfly", right: "silver", correct: "silver" },
  { word: "figure", biasMeaning: "ì¸ë¬¼", sentence: "She saw a dark <u>figure</u> standing by the window.", left: "silhouette", right: "statistics", correct: "silhouette" },
  { word: "figure", biasMeaning: "ìˆ«ì", sentence: "The company had yearly sales <u>figures</u> of half a million units.", left: "silhouette", right: "statistics", correct: "statistics" },
  { word: "board", biasMeaning: "ì¹ íŒ", sentence: "The teacher wrote the answer on the <u>board</u>.", left: "chalk", right: "chairman", correct: "chalk" },
  { word: "board", biasMeaning: "ì´ì‚¬íšŒ", sentence: "The <u>board</u> of directors meets every month.", left: "chalk", right: "chairman", correct: "chairman" },
  { word: "pupil", biasMeaning: "ëˆˆë™ì", sentence: "Her <u>pupil</u> dilated in the dark room.", left: "glasses", right: "homework", correct: "glasses" },
  { word: "pupil", biasMeaning: "í•™ìƒ", sentence: "The teacher helped the <u>pupil</u> with the lesson.", left: "glasses", right: "homework", correct: "homework" },
  { word: "bark", biasMeaning: "ê°œ ì§–ëŠ” ì†Œë¦¬", sentence: "I woke up because of the dogâ€™s <u>bark</u>.", left: "leash", right: "axe", correct: "leash" },
  { word: "bark", biasMeaning: "ë‚˜ë¬´ê»ì§ˆ", sentence: "The tree had rough <u>bark</u> on its outer layer.", left: "leash", right: "axe", correct: "axe" },
  { word: "race", biasMeaning: "ì¸ì¢…", sentence: "People of every <u>race</u> should be treated equally.", left: "bias", right: "speed", correct: "bias" },
  { word: "race", biasMeaning: "ê²½ì£¼", sentence: "She won the <u>race</u> and got a gold medal.", left: "bias", right: "speed", correct: "speed" },
  { word: "date", biasMeaning: "ë‚ ì§œ", sentence: "We need to choose a <u>date</u> for the presentation.", left: "calender", right: "boyfriend", correct: "calender" },
  { word: "date", biasMeaning: "ë°ì´íŠ¸", sentence: "He asked me out on a <u>date</u> for Saturday.", left: "calender", right: "boyfriend", correct: "boyfriend" }
];

const realTrials = [
  mainTrials[14], mainTrials[18], mainTrials[9], mainTrials[16], mainTrials[2],
  mainTrials[4], mainTrials[15], mainTrials[10], mainTrials[1], mainTrials[5],
  mainTrials[6], mainTrials[3], mainTrials[19], mainTrials[12], mainTrials[17],
  mainTrials[8], mainTrials[0], mainTrials[11], mainTrials[13], mainTrials[7]
];

const allTrials = [...practiceTrials, ...realTrials];

let currentIndex = 0;
let participant = "";
let results = [];
let readingStartTime = 0;
let decisionStartTime = 0;

document.getElementById("startBtn").addEventListener("click", handleStart);
document.getElementById("participantName").addEventListener("keydown", (e) => {
  if (e.key === "Enter") handleStart();
});

function handleStart() {
  const name = document.getElementById("participantName").value.trim();
  if (!name) {
    alert("ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.");
    return;
  }
  participant = name;
  document.getElementById("inputName").style.display = "none";
  document.getElementById("instructions").style.display = "block";
  setTimeout(() => document.addEventListener("keydown", handleSpaceStart), 300);
}

function handleSpaceStart(e) {
  if (e.code === "Space" || e.code === "Enter") {
    document.removeEventListener("keydown", handleSpaceStart);
    document.getElementById("instructions").style.display = "none";
    nextTrial();
  }
}

function nextTrial() {
  if (currentIndex >= allTrials.length) return endExperiment();

  const isPractice = currentIndex < practiceTrials.length;
  document.getElementById("progress").style.display = isPractice ? "none" : "block";
  if (!isPractice) {
    document.getElementById("progress").textContent = `ì§„í–‰ë„: ${currentIndex - practiceTrials.length + 1}/${realTrials.length}`;
  }

  document.getElementById("feedback").textContent = "";
  const trial = allTrials[currentIndex];
  document.getElementById("sentence").innerHTML = trial.sentence;
  document.getElementById("sentence").style.display = "block";
  document.getElementById("options").style.display = "none";

  readingStartTime = performance.now();

  setTimeout(() => document.addEventListener("keydown", handleContinue), 100);
}

function handleContinue(e) {
  if (e.code !== "Space" && e.code !== "Enter") return;
  document.removeEventListener("keydown", handleContinue);

  const trial = allTrials[currentIndex];
  const readingTime = (performance.now() - readingStartTime) / 1000;

  const isLeftCorrect = Math.random() < 0.5;
  const left = isLeftCorrect ? trial.correct : (trial.left === trial.correct ? trial.right : trial.left);
  const right = isLeftCorrect ? (trial.left === trial.correct ? trial.right : trial.left) : trial.correct;

  document.getElementById("options").textContent = `${left} vs ${right}`;
  document.getElementById("sentence").style.display = "none";
  document.getElementById("options").style.display = "block";

  decisionStartTime = performance.now();

  document.addEventListener("keydown", function handler(e) {
    if (e.code !== "ArrowLeft" && e.code !== "ArrowRight") return;
    document.removeEventListener("keydown", handler);

    const chosen = e.code === "ArrowLeft" ? left : right;
    const correct = chosen === trial.correct;
    const RT = (performance.now() - decisionStartTime) / 1000;

    results.push({
      word: trial.word,
      biasMeaning: trial.biasMeaning,
      sentence: trial.sentence.replace(/<[^>]*>?/gm, ''),
      left_word: left,
      right_word: right,
      correct_word: trial.correct,
      chosen_word: chosen,
      correct: correct,
      readingTime: readingTime,
      RT: RT,
      phase: currentIndex < practiceTrials.length ? "practice" : "main"
    });

    const feedback = document.getElementById("feedback");
    if (currentIndex < practiceTrials.length) {
      feedback.textContent = correct ? "ì •ë‹µ!" : "ì˜¤ë‹µ!";
      feedback.style.color = correct ? "green" : "red";
    } else {
      feedback.textContent = "";
    }

    currentIndex++;

    if (currentIndex === practiceTrials.length) {
      setTimeout(() => {
        document.getElementById("options").style.display = "none";
        document.getElementById("feedback").textContent = "";
        document.getElementById("transition").style.display = "block";
        document.addEventListener("keydown", function waitMainStart(ev) {
          if (ev.code === "Space" || ev.code === "Enter") {
            document.removeEventListener("keydown", waitMainStart);
            document.getElementById("transition").style.display = "none";
            nextTrial();
          }
        });
      }, 1000);
    } else {
      setTimeout(nextTrial, 1000);
    }
  });
}

function endExperiment() {
  document.getElementById("sentence").innerHTML = "ì‹¤í—˜ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!";
  document.getElementById("options").style.display = "none";
  document.getElementById("downloadBtn").style.display = "inline";
}

function downloadCSV() {
  const header = ["word", "biasMeaning", "sentence", "left_word", "right_word", "correct_word", "chosen_word", "correct", "readingTime", "RT"];
  const rows = results.map(r => [
    r.word, r.biasMeaning, r.sentence, r.left_word, r.right_word,
    r.correct_word, r.chosen_word, r.correct, r.readingTime, r.RT
  ]);
  const csvContent = [header, ...rows].map(r => r.join(",")).join("\n");

  // BOM ì¶”ê°€
  const bom = "\uFEFF";
  const blob = new Blob([bom + csvContent], { type: "text/csv;charset=utf-8;" });

  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = `context_selection_${participant}.csv`;
  link.click();
}
</script>
</body>
</html>